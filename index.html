<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Typing Test — BERANI Export Import</title>

  <style>
    :root{
      --bg:#f6f0e8; --card:#ffffff; --ink:#111; --muted:#6b6b6b;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius:18px; --green:#2bb673; --red:#e34b4b; --dark:#1a1a1a;
      --line:#e9dccf; --btn:#f2b07b; --btnText:#1a1a1a; --btnDisabled:#e8e1d9;
      --accent:#ff7a1a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 600px at 50% 0%, #fff, var(--bg));
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .app{ width:min(980px, 100%); display:grid; grid-template-columns: 320px 1fr; gap:18px; align-items:start; }
    .panel{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid var(--line); }
    .badge{ border-radius:14px; padding:10px 12px; border:1px solid var(--line); background:#fff7ef; }
    .badge .title{ font-weight:1000; letter-spacing:.5px; margin:0; font-size:16px; line-height:1.1; }
    .badge .sub{ margin:4px 0 0 0; color:var(--accent); font-weight:900; font-size:12px; letter-spacing:.6px; }

    .btn{
      border:none; border-radius:14px; padding:12px 14px; background:var(--btn);
      color:var(--btnText); font-weight:900; cursor:pointer; box-shadow: 0 6px 0 rgba(0,0,0,.08);
      transition: transform .08s ease; user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{ background:#fff; border:1px solid var(--line); box-shadow:none; font-weight:900; }
    .btn.ghost{ background:#f7f2ec; border:1px dashed #d9c6b3; box-shadow:none; color:#3b3b3b; font-weight:900; }
    .btn:disabled{ background:var(--btnDisabled); border:1px solid #e0d7cd; color:#9a8f85; cursor:not-allowed; box-shadow:none; }

    .statsRow{ display:grid; grid-template-columns: 1fr; gap:10px; margin:10px 0 14px; }
    .pill{ display:flex; align-items:center; justify-content:space-between; padding:12px 12px; border-radius:14px; color:#fff; font-weight:1000; }
    .pill.green{background:var(--green)} .pill.red{background:var(--red)} .pill.dark{background:#1f1f1f}
    .pill span{font-size:13px; font-weight:900; opacity:.95} .pill b{font-size:18px}

    .meta{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 2px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); padding:8px 10px; border-radius:999px; background:#fff; font-weight:900; font-size:12px; color:#333; }
    .dot{width:10px;height:10px;border-radius:50%} .dot.orange{background:#ff8a2a} .dot.gray{background:#b9b0a8}

    .idBox{ border:1px solid var(--line); background:#fff; border-radius:14px; padding:10px 12px; font-weight:900; color:#222; line-height:1.3; }
    .idBox small{ display:block; font-weight:800; color:var(--muted); margin-bottom:4px; }

    .controls{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .footerRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; padding-top:10px; border-top:1px dashed #e2d4c6; color:#333; font-weight:900; font-size:12px; }

    .mainHeader{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .mainHeader h1{ margin:0; font-size:18px; font-weight:1000; }
    .subline{ margin:2px 0 0; color:var(--muted); font-size:13px; font-weight:800; }
    .modeLine{ margin:6px 0 10px; font-weight:1000; color:#2d2d2d; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modeTag{ background:#fff7ef; border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; font-weight:1000; color:#b14b00; }

    .tabs{ display:flex; gap:10px; margin-top:10px; }
    .tabBtn{ flex:1; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#fff; font-weight:1000; cursor:pointer; }
    .tabBtn.active{ background:#fff7ef; border-color:#f2b07b; }
    .view{display:none} .view.active{display:block}

    .promptBox{
      background:#fff; border:1px solid var(--line); border-radius:16px; padding:14px;
      min-height:110px; line-height:1.75; font-size:16px; font-weight:900;
      box-shadow: inset 0 0 0 2px rgba(242,176,123,.08);
      white-space: pre-wrap;
    }
    .promptBox .done{color:#9fb39a}
    .promptBox .current{ background:#fff2e6; border-radius:6px; padding:1px 2px; }
    .promptBox .bad{ background:#ffe1e1; border-radius:6px; padding:1px 2px; }

    .chunkBar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 8px;}
    .chunkBar .chunkInfo{font-weight:1000; font-size:12px; color:#333;}
    .chunkBar .chunkInfo b{color:#111;}
    .chunkBar .tip{font-weight:900; font-size:12px; color:#666;}
    .chunkBar .tip kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight:1000; padding:2px 6px; border-radius:8px; border:1px solid var(--line); background:#fff;}

    textarea{
      width:100%; border:1px solid var(--line); border-radius:16px; padding:14px; font-size:16px; font-weight:900;
      outline:none; min-height:130px; resize:none; background:#fff;
      line-height:1.6;
    }
    textarea:focus{ border-color:#f2b07b; box-shadow: 0 0 0 4px rgba(242,176,123,.22); }

    .hint{ margin-top:10px; font-size:12px; color:#4b4b4b; line-height:1.5; font-weight:800; }

    .reportGrid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px; }
    @media (max-width: 640px){ .reportGrid{grid-template-columns:1fr} }
    .kpiCard{ border:1px solid var(--line); border-radius:16px; padding:12px; background:#fff; }
    .kpiCard .label{ font-size:12px; color:var(--muted); font-weight:1000; margin:0 0 4px; }
    .kpiCard .value{ font-size:20px; font-weight:1100; margin:0; }

    canvas{ width:100%; height:240px; border:1px solid var(--line); border-radius:16px; background:#fff; }

    /* MODAL */
    .modalOverlay{ position:fixed; inset:0; background: rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:16px; z-index:999; }
    .modalCard{ width:min(640px, 100%); background:#fff; border-radius:20px; padding:18px; border:1px solid var(--line); box-shadow: 0 18px 50px rgba(0,0,0,.25); }
    .modalTitle{ margin:0 0 6px 0; font-size:18px; font-weight:1100; }
    .modalDesc{ margin:0 0 14px 0; color:var(--muted); font-weight:800; font-size:13px; line-height:1.4; }
    .formRow{ margin-bottom:12px; }
    .formLabel{ display:block; font-weight:1000; font-size:12px; margin-bottom:6px; color:#222; }
    .formInput{ width:100%; border:1px solid var(--line); border-radius:14px; padding:12px 12px; font-size:16px; font-weight:900; outline:none; }
    .formInput:focus{ border-color:#f2b07b; box-shadow: 0 0 0 4px rgba(242,176,123,.22); }
    .formError{ color:#d00000; font-weight:900; font-size:12px; margin-top:6px; min-height:16px; }
    .modePick{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .pickBtn{ border-radius:14px; border:1px solid var(--line); background:#fff; padding:12px 10px; font-weight:1100; cursor:pointer; }
    .pickBtn.active{ background:#1a1a1a; color:#fff; border-color:#1a1a1a; }
    .modalNote{ margin-top:8px; color:#4b4b4b; font-weight:800; font-size:12px; line-height:1.45; }
    .modalCTA{ width:100%; margin-top:6px; height:48px; border-radius:14px; font-size:16px; }
    @media (max-width: 420px){ .modePick{ grid-template-columns:1fr; } }

    /* ===== MOBILE: sidebar jadi ringkas (soal tidak ketutup) ===== */
    @media (max-width: 860px){
      body{ align-items:flex-start; justify-content:flex-start; padding:12px; }
      .app{ width:100%; grid-template-columns: 1fr; gap:12px; }
      .panel.sidebar{
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 10px;
      }

      #btnToggleStats{ display:block !important; }

      /* default: detail disembunyikan */
      #sidebarDetails{ display:none; }
      .sidebar-expanded #sidebarDetails{ display:block; }

      /* supaya sidebar tidak makan seluruh layar saat expanded */
      .sidebar-expanded .panel.sidebar{
        max-height: 55vh;
        overflow: auto;
      }

      .promptBox{ max-height: 22vh; overflow:auto; font-size:15px; line-height:1.7; }
      textarea{ min-height: 38vh; font-size:16px; }
      canvas{ height: 200px; }
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 420px){
      .controls{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="panel sidebar">
      <div class="badge" style="margin-bottom:10px">
        <p class="title">BERANI</p>
        <p class="sub">EXPORT&nbsp;&nbsp;IMPORT</p>
      </div>

      <div class="idBox" id="idBox">
        <small>Identitas Kandidat</small>
        <div id="idName">Nama: -</div>
        <div id="idPhone">No HP: -</div>
      </div>

      <button class="btn secondary" id="btnNew" style="margin-top:10px">Kandidat Baru</button>

      <!-- MOBILE toggle (muncul hanya di HP via CSS) -->
      <button class="btn secondary" id="btnToggleStats" style="margin-top:10px; display:none;">Tampilkan Detail</button>

      <div id="sidebarDetails">
        <div class="statsRow">
          <div class="pill green"><span>Benar</span><b id="okCount">0</b></div>
          <div class="pill red"><span>Salah</span><b id="errCount">0</b></div>
          <div class="pill dark"><span>Waktu</span><b id="timeLeft">00:00</b></div>
        </div>

        <div class="meta">
          <span class="chip"><span class="dot orange"></span> HR-AI Rekrutmen</span>
          <span class="chip"><span class="dot gray"></span> Typing Test</span>
        </div>

        <div class="controls">
          <button class="btn ghost" id="btnStart" disabled>Mulai</button>
          <button class="btn ghost" id="btnFinish" disabled>Selesai</button>
        </div>

        <div class="controls">
          <button class="btn secondary" id="btnReport" disabled>Report</button>
          <button class="btn secondary" id="btnCurve" disabled>Kurva Kerja</button>
        </div>

        <div class="hint">
          <b>Aturan:</b> Latihan 1 menit → otomatis lanjut tes 10 menit.<br/>
          Tes utama menggunakan <b>soal per 3 baris</b>. Tekan <b>Enter</b> untuk lanjut bagian berikutnya.
        </div>

        <div class="footerRow">
          <span id="statusText">Status: standby</span>
          <span id="itemTotal">Item total: 0</span>
        </div>
      </div>
    </div>

    <div class="panel main">
      <div class="mainHeader">
        <div>
          <h1>Typing Test</h1>
          <p class="subline">Ketik sesuai teks. Fokus ke akurasi & konsistensi.</p>
        </div>
      </div>

      <div class="modeLine">
        <div>
          <span id="modeName">Mode: Standby</span>
          <span style="display:inline-block; width:8px"></span>
          <span class="modeTag" id="modeTag">—</span>
        </div>
        <div style="font-weight:1000;color:#222" id="minuteLine">Menit 0 / 10</div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="testView">Tes</button>
        <button class="tabBtn" data-tab="reportView">Report</button>
        <button class="tabBtn" data-tab="curveView">Kurva Kerja</button>
      </div>

      <div class="view active" id="testView">
        <div class="promptBox" id="promptBox"></div>

        <div class="chunkBar">
          <div class="chunkInfo" id="chunkInfo">Bagian: <b>-</b></div>
          <div class="tip">Lanjut bagian: tekan <kbd>Enter</kbd></div>
        </div>

        <textarea id="inputBox" placeholder="Mulai mengetik di sini..." disabled></textarea>
        <div class="hint" id="liveHint">Silakan isi identitas kandidat terlebih dahulu.</div>
      </div>

      <div class="view" id="reportView">
        <div class="reportGrid">
          <div class="kpiCard"><p class="label">WPM (kata/menit)</p><p class="value" id="rWpm">0</p></div>
          <div class="kpiCard"><p class="label">KPM (karakter/menit)</p><p class="value" id="rCpm">0</p></div>
          <div class="kpiCard"><p class="label">Akurasi</p><p class="value" id="rAcc">0%</p></div>
          <div class="kpiCard"><p class="label">Total Karakter</p><p class="value" id="rChars">0</p></div>
          <div class="kpiCard"><p class="label">Benar</p><p class="value" id="rOk">0</p></div>
          <div class="kpiCard"><p class="label">Salah</p><p class="value" id="rErr">0</p></div>
        </div>

        <div class="hint" style="margin-top:12px">
          <b>Catatan:</b> WPM = (karakter benar / 5) per menit. Akurasi = benar / (benar + salah).
        </div>

        <div style="height:10px"></div>
        <button class="btn" id="btnSave" disabled>Kirim Ulang ke Sheet</button>
        <div class="hint">Auto-kirim dilakukan saat tes selesai. Tombol ini untuk kirim ulang jika diperlukan.</div>
      </div>

      <div class="view" id="curveView">
        <canvas id="curveCanvas" width="900" height="300"></canvas>
        <div class="hint">Kurva WPM per menit (hanya tes 10 menit, tidak termasuk latihan).</div>
      </div>
    </div>
  </div>

  <div id="candidateModal" class="modalOverlay" aria-hidden="false">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle" class="modalTitle">Data Kandidat</h2>
      <p class="modalDesc">Isi dulu data kandidat sebelum tes dimulai (untuk report & kirim ke Google Sheet).</p>

      <div class="formRow">
        <label class="formLabel" for="candName">Nama Kandidat</label>
        <input id="candName" class="formInput" type="text" placeholder="Contoh: Muhammad Naufal" autocomplete="name" />
        <div class="formError" id="errName"></div>
      </div>

      <div class="formRow">
        <label class="formLabel" for="candPhone">No HP (format 08xxxxxxxxxx)</label>
        <input id="candPhone" class="formInput" type="tel" inputmode="numeric" placeholder="08xxxxxxxxxx" autocomplete="tel" />
        <div class="formError" id="errPhone"></div>
      </div>

      <div class="formRow">
        <label class="formLabel">Pilih Mode Tes</label>
        <div class="modePick">
          <button type="button" class="pickBtn active" data-mode="practice">Latihan 1 menit</button>
          <button type="button" class="pickBtn" data-mode="test">Tes 10 menit</button>
        </div>
        <div class="modalNote">
          • Latihan: untuk pemanasan / coba tombol.<br/>
          • Tes: untuk hasil evaluasi.
        </div>
      </div>

      <button id="btnModalStart" class="btn modalCTA">Lanjut & Mulai</button>
    </div>
  </div>

<script>
(() => {
  // =========================
  // 1) KONFIGURASI
  // =========================
  // GANTI dengan Web App URL kamu (yang /exec)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwd1YbX-HnflBc0bsd-BcjVR09EV5rBxsCuR-543xc-ardVn9IHb_n-z-6kAU3mJrWs/exec";

  const PRACTICE_SECONDS = 60;
  const TEST_SECONDS = 600;
  const WORD_UNIT = 5;

  // =========================
  // 2) BANK TEXT (akan dipotong jadi 3 baris per bagian)
  // =========================
  const PRACTICE_TEXT = [
    "Fokus pada akurasi dan ritme. Ketik dengan tenang tanpa terburu-buru.",
    "Latihan satu menit ini untuk pemanasan. Setelah itu tes utama dimulai."
  ].join(" ");

  const TEST_TEXTS = [
    "Kerja yang rapi dimulai dari kebiasaan kecil: menamai file dengan jelas, menyimpan dokumen pada folder yang benar, dan menutup pekerjaan dengan cek ulang. Kebiasaan ini membuat tim bergerak lebih cepat dan meminimalkan kesalahan yang tidak perlu.",
    "Dalam pekerjaan administrasi, ketelitian lebih penting daripada kecepatan sesaat. Pastikan angka, nama, tanggal, dan dokumen sesuai sebelum menekan tombol kirim. Satu kesalahan kecil bisa membuat proses tertunda dan harus diulang.",
    "Komunikasi yang baik bukan soal kalimat panjang, tetapi pesan yang jelas. Sampaikan konteks, tujuan, dan langkah yang diharapkan agar orang lain mudah memahami dan menindaklanjuti tanpa kebingungan.",
    "Saat menghadapi perubahan, tetap tenang dan fokus pada langkah berikutnya. Pecah masalah menjadi bagian kecil, selesaikan satu per satu, lalu validasi hasilnya sebelum melanjutkan ke tahap berikutnya.",
    "Manajemen waktu bisa dimulai dari hal sederhana: tentukan prioritas harian, buat daftar tugas singkat, dan blok waktu untuk pekerjaan fokus. Hindari berpindah-pindah tugas terlalu sering karena membuat energi cepat habis.",
    "Kualitas kerja ditentukan oleh konsistensi. Lebih baik stabil dan rapi daripada cepat tetapi sering salah. Jika ragu, berhenti sebentar, baca ulang instruksi, dan pastikan langkah yang diambil sudah sesuai.",
    "Kerja tim membutuhkan standar yang sama. Gunakan format penamaan file yang seragam, catatan yang ringkas, dan update status secara rutin. Standar ini membantu semua orang memahami progres tanpa perlu bertanya berulang kali.",
    "Dalam dunia bisnis, keputusan yang baik berangkat dari data. Catat hasil, hitung rasio, dan lihat tren. Dengan data, evaluasi menjadi lebih objektif dan langkah perbaikan bisa lebih tepat sasaran.",
    "Saat menerima tugas baru, pastikan memahami definisi berhasilnya pekerjaan. Tanyakan batas waktu, output yang diharapkan, dan kriteria kualitas. Dengan begitu, pekerjaan lebih terarah dan risiko revisi berkurang.",
    "Jika terjadi kesalahan, fokus pada perbaikan, bukan menyalahkan. Identifikasi penyebab, perbaiki proses, lalu buat langkah pencegahan agar kesalahan yang sama tidak terulang.",
    "Ketahanan kerja dibangun lewat ritme. Atur napas, jaga konsentrasi, dan konsisten pada pola kerja yang rapi. Saat lelah, ambil jeda singkat lalu kembali fokus pada satu langkah berikutnya.",
    "Sikap profesional terlihat dari cara menindaklanjuti. Setelah menerima informasi, buat rangkuman singkat, konfirmasi poin penting, lalu jalankan tindakan yang disepakati. Ini menghindari miskomunikasi.",
    "Dokumentasi adalah investasi. Catatan kecil hari ini bisa menghemat banyak waktu besok. Simpan ringkasan rapat, keputusan, dan alasan perubahan agar tim mudah melacak riwayat pekerjaan.",
    "Disiplin bukan berarti kaku, tetapi konsisten. Datang tepat waktu, menyelesaikan tugas sesuai kesepakatan, dan menjaga kualitas output adalah tanda tanggung jawab yang bisa dipercaya.",
    "Setiap pekerjaan punya risiko. Cara menguranginya adalah cek dua kali pada bagian penting: angka, nama, alamat, jadwal, serta detail yang menjadi penentu keputusan. Jangan terburu-buru pada tahap akhir."
  ];

  // =========================
  // 3) STATE
  // =========================
  const state = {
    phase: "idle",              // idle | practice | test | done
    timerId: null,
    secondsLeft: 0,

    // global score (test only, practice akan reset)
    ok: 0,
    err: 0,
    total: 0,
    charOkTotal: 0,

    // minute curve
    wpmByMinute: Array(10).fill(0),
    minuteIndex: 0,
    minuteCharOkStart: 0,
    startAt: 0,

    // chunk mode (3 lines)
    chunks: [],                 // array of chunk strings
    chunkIndex: 0,              // active chunk
    chunkTypedRaw: "",          // what user typed in input
    chunkOk: 0,
    chunkErr: 0,

    // practice mode uses single prompt (not chunked)
    practicePrompt: PRACTICE_TEXT
  };

  const candidate = { name:"", phone:"", mode:"practice" };

  // =========================
  // 4) ELEMENTS
  // =========================
  const el = {
    okCount: document.getElementById("okCount"),
    errCount: document.getElementById("errCount"),
    timeLeft: document.getElementById("timeLeft"),
    statusText: document.getElementById("statusText"),
    itemTotal: document.getElementById("itemTotal"),

    modeName: document.getElementById("modeName"),
    modeTag: document.getElementById("modeTag"),
    minuteLine: document.getElementById("minuteLine"),

    promptBox: document.getElementById("promptBox"),
    inputBox: document.getElementById("inputBox"),
    liveHint: document.getElementById("liveHint"),

    btnNew: document.getElementById("btnNew"),
    btnStart: document.getElementById("btnStart"),
    btnFinish: document.getElementById("btnFinish"),
    btnReport: document.getElementById("btnReport"),
    btnCurve: document.getElementById("btnCurve"),
    btnSave: document.getElementById("btnSave"),

    btnToggleStats: document.getElementById("btnToggleStats"),
    sidebar: document.querySelector(".panel.sidebar"),

    tabs: [...document.querySelectorAll(".tabBtn")],
    views: {
      testView: document.getElementById("testView"),
      reportView: document.getElementById("reportView"),
      curveView: document.getElementById("curveView")
    },

    rWpm: document.getElementById("rWpm"),
    rCpm: document.getElementById("rCpm"),
    rAcc: document.getElementById("rAcc"),
    rChars: document.getElementById("rChars"),
    rOk: document.getElementById("rOk"),
    rErr: document.getElementById("rErr"),

    canvas: document.getElementById("curveCanvas"),
    idName: document.getElementById("idName"),
    idPhone: document.getElementById("idPhone"),

    chunkInfo: document.getElementById("chunkInfo"),
  };

  const modal = document.getElementById("candidateModal");
  const inpName = document.getElementById("candName");
  const inpPhone = document.getElementById("candPhone");
  const errName = document.getElementById("errName");
  const errPhone = document.getElementById("errPhone");
  const btnModalStart = document.getElementById("btnModalStart");
  const pickBtns = [...document.querySelectorAll(".pickBtn")];

  // =========================
  // 5) UTIL
  // =========================
  const pad2 = n => String(n).padStart(2,"0");
  const fmtTime = s => `${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
  const clamp = (v,min,max) => Math.max(min, Math.min(max,v));
  const randPick = arr => arr[Math.floor(Math.random()*arr.length)];

  function escapeHtml(str){
    return (str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function switchTab(viewId){
    for (const t of el.tabs) t.classList.toggle("active", t.dataset.tab === viewId);
    for (const [id,v] of Object.entries(el.views)) v.classList.toggle("active", id === viewId);
  }

  function normalizePhone(p){
    let x = (p||"").toString().replace(/\D/g,"");
    if (x.startsWith("62")) x = "0" + x.slice(2);
    return x;
  }
  function isValidPhone(p){ return /^08\d{8,11}$/.test(p); }

  // Normalisasi teks untuk menghindari "bug dianggap salah" karena karakter invisible / spasi ganjil:
  // - samakan newline \r\n -> \n
  // - hilangkan NBSP
  // - normalisasi tanda kutip
  // - kompres spasi ganda menjadi satu (tapi tetap menjaga newline)
  function normalizeTextForCompare(s){
    return (s||"")
      .replace(/\r\n/g, "\n")
      .replace(/\u00A0/g, " ")
      .replace(/[“”]/g, '"')
      .replace(/[‘’]/g, "'")
      .replace(/[ \t]+/g, " ")
      .replace(/[ ]+\n/g, "\n")
      .replace(/\n[ ]+/g, "\n");
  }

  // =========================
  // 6) BUILD CHUNKS (3 BARIS)
  // =========================
  // Kita buat teks panjang dari bank, lalu "wrap" ke lebar karakter agar jadi beberapa baris.
  // Setelah itu, gabungkan per 3 baris sebagai 1 chunk.
  function buildLongText(minChars = 6500){
    let out = "";
    while (out.length < minChars){
      out += (out ? " " : "") + randPick(TEST_TEXTS);
    }
    return out.trim();
  }

  // Wrap naive by char length (biar konsisten di HP/Desktop tanpa tergantung font)
  function wrapToLines(text, maxLen=62){
    const words = text.split(/\s+/).filter(Boolean);
    const lines = [];
    let line = "";
    for (const w of words){
      if (!line.length){
        line = w;
      } else if ((line.length + 1 + w.length) <= maxLen){
        line += " " + w;
      } else {
        lines.push(line);
        line = w;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  function linesToChunks(lines, linesPerChunk=3){
    const chunks = [];
    for (let i=0;i<lines.length;i+=linesPerChunk){
      const part = lines.slice(i, i+linesPerChunk).join("\n");
      chunks.push(part);
    }
    return chunks;
  }

  function buildChunks(){
    const longText = buildLongText(8000);
    const lines = wrapToLines(longText, 62);
    const chunks = linesToChunks(lines, 3);

    // Pastikan minimal chunk cukup banyak (10 menit). Tambahkan lagi jika kurang.
    while (chunks.length < 40){
      const more = wrapToLines(buildLongText(2500), 62);
      chunks.push(...linesToChunks(more, 3));
    }
    return chunks;
  }

  // =========================
  // 7) UI HELPERS
  // =========================
  function syncIdentityUI(){
    el.idName.textContent = `Nama: ${candidate.name || "-"}`;
    el.idPhone.textContent = `No HP: ${candidate.phone || "-"}`;
  }

  function setPick(mode){
    candidate.mode = mode;
    pickBtns.forEach(b => b.classList.toggle("active", b.dataset.mode === mode));
  }

  function openCandidateModal(){
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");

    try{
      const saved = JSON.parse(localStorage.getItem("bei_candidate") || "null");
      if (saved && saved.name && saved.phone){
        inpName.value = saved.name;
        inpPhone.value = saved.phone;
      }
    }catch(e){}

    setPick(candidate.mode || "practice");
    el.btnStart.disabled = true;
    el.btnFinish.disabled = true;
    el.inputBox.disabled = true;

    setTimeout(() => inpName.focus(), 80);
  }

  function closeCandidateModal(){
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
  }

  function setPhase(phase){
    state.phase = phase;

    if (phase === "idle"){
      el.modeName.textContent = "Mode: Standby";
      el.modeTag.textContent = "—";
      el.statusText.textContent = "Status: standby";
      el.minuteLine.textContent = "Menit 0 / 10";

      el.btnReport.disabled = true;
      el.btnCurve.disabled = true;
      el.btnSave.disabled = true;

      el.btnStart.disabled = !candidate.phone;
      el.btnFinish.disabled = true;
      el.inputBox.disabled = true;
    }

    if (phase === "practice"){
      el.modeName.textContent = "Mode: Latihan";
      el.modeTag.textContent = "1 menit";
      el.statusText.textContent = "Status: latihan";
      el.btnFinish.disabled = false;
      el.inputBox.disabled = false;
      el.btnStart.disabled = true;
      el.inputBox.focus();
      el.chunkInfo.innerHTML = "Latihan (bebas)";
    }

    if (phase === "test"){
      el.modeName.textContent = "Mode: Tes Utama";
      el.modeTag.textContent = "10 menit";
      el.statusText.textContent = "Status: mengerjakan";
      el.btnFinish.disabled = false;
      el.inputBox.disabled = false;
      el.btnStart.disabled = true;
      el.inputBox.focus();
    }

    if (phase === "done"){
      el.modeName.textContent = "Mode: Selesai";
      el.modeTag.textContent = "hasil tersedia";
      el.statusText.textContent = "Status: selesai";

      el.btnReport.disabled = false;
      el.btnCurve.disabled = false;
      el.btnSave.disabled = false;

      el.btnStart.disabled = false;
      el.btnFinish.disabled = true;
      el.inputBox.disabled = true;
    }
  }

  function resetAll(){
    clearInterval(state.timerId);
    state.timerId = null;

    state.secondsLeft = 0;

    state.ok = 0;
    state.err = 0;
    state.total = 0;
    state.charOkTotal = 0;

    state.wpmByMinute = Array(10).fill(0);
    state.minuteIndex = 0;
    state.minuteCharOkStart = 0;
    state.startAt = 0;

    state.chunks = [];
    state.chunkIndex = 0;
    state.chunkTypedRaw = "";
    state.chunkOk = 0;
    state.chunkErr = 0;

    el.inputBox.value = "";
    el.okCount.textContent = "0";
    el.errCount.textContent = "0";
    el.timeLeft.textContent = "00:00";
    el.itemTotal.textContent = "Item total: 0";

    el.promptBox.textContent = "";
    el.chunkInfo.innerHTML = "Bagian: <b>-</b>";
    el.liveHint.innerHTML = candidate.phone
      ? "Tekan <b>Mulai</b> untuk memulai sesuai mode yang dipilih."
      : "Silakan isi identitas kandidat terlebih dahulu.";

    updateReport();
    drawCurve();
    setPhase("idle");
    switchTab("testView");
    syncIdentityUI();
  }

  // =========================
  // 8) SHEET SENDER (GET beacon)
  // =========================
  function saveToSheet(payload){
    if (!payload.kandidatNoHP) return;

    const qs = new URLSearchParams({
      nama: payload.kandidatNama || "",
      nohp: payload.kandidatNoHP || "",
      mode: payload.modeDipilih || "",
      durasi: String(payload.durationMinutes || ""),
      total: String(payload.total || 0),
      benar: String(payload.benar || 0),
      salah: String(payload.salah || 0),
      akurasi: String(payload.akurasi || 0),
      wpm: String(payload.wpm || 0),
      permenit: JSON.stringify(payload.wpmByMinute || [])
    });

    const img = new Image();
    img.src = WEB_APP_URL + "?" + qs.toString();
  }

  // =========================
  // 9) PRACTICE
  // =========================
  function startPractice(){
    clearInterval(state.timerId);

    state.ok = 0; state.err = 0; state.total = 0; state.charOkTotal = 0;
    state.wpmByMinute = Array(10).fill(0);
    state.minuteIndex = 0;
    state.minuteCharOkStart = 0;
    state.startAt = 0;

    state.chunkTypedRaw = "";
    el.inputBox.value = "";

    el.promptBox.textContent = state.practicePrompt;
    el.chunkInfo.innerHTML = "Latihan (bebas)";

    state.secondsLeft = PRACTICE_SECONDS;
    el.timeLeft.textContent = fmtTime(state.secondsLeft);
    el.liveHint.innerHTML = "Latihan dimulai. Fokus akurasi, jangan buru-buru.";
    setPhase("practice");

    tickLoop(() => startTest());
  }

  // =========================
  // 10) TEST (3-bar line chunks + Enter)
  // =========================
  function startTest(){
    clearInterval(state.timerId);

    state.ok = 0; state.err = 0; state.total = 0; state.charOkTotal = 0;
    state.wpmByMinute = Array(10).fill(0);
    state.minuteIndex = 0;
    state.minuteCharOkStart = 0;

    state.chunks = buildChunks();
    state.chunkIndex = 0;
    state.chunkTypedRaw = "";
    state.chunkOk = 0;
    state.chunkErr = 0;

    el.inputBox.value = "";
    el.okCount.textContent = "0";
    el.errCount.textContent = "0";
    el.itemTotal.textContent = "Item total: 0";

    state.secondsLeft = TEST_SECONDS;
    state.startAt = Date.now();

    el.timeLeft.textContent = fmtTime(state.secondsLeft);
    el.liveHint.innerHTML = "Tes utama dimulai (10 menit). Ketik 3 baris, lalu tekan <b>Enter</b> untuk lanjut.";
    setPhase("test");

    showChunk();

    tickLoop(() => finishNow(true));
  }

  function showChunk(){
    const idx = state.chunkIndex;
    const total = state.chunks.length;
    const chunk = state.chunks[idx] || "";
    state.chunkTypedRaw = "";
    el.inputBox.value = "";
    el.chunkInfo.innerHTML = `Bagian: <b>${idx+1}</b> / ${total}`;

    renderChunkPrompt("", chunk);
    el.inputBox.focus();
  }

  // Render prompt chunk with highlighting (based on current typed)
  function renderChunkPrompt(typedRaw, chunkRaw){
    const typed = normalizeTextForCompare(typedRaw || "");
    const chunk = normalizeTextForCompare(chunkRaw || "");

    const upto = Math.min(typed.length, chunk.length);

    let html = "";
    for (let i=0;i<chunk.length;i++){
      const ch = chunk[i];
      if (i < upto){
        html += (typed[i] === ch)
          ? `<span class="done">${escapeHtml(ch)}</span>`
          : `<span class="bad">${escapeHtml(ch)}</span>`;
      } else if (i === upto && state.phase === "test"){
        html += `<span class="current">${escapeHtml(ch)}</span>`;
      } else {
        html += escapeHtml(ch);
      }
    }
    el.promptBox.innerHTML = html;
  }

  function computeChunkRealtime(){
    const rawTyped = el.inputBox.value || "";
    const rawChunk = state.chunks[state.chunkIndex] || "";

    const typed = normalizeTextForCompare(rawTyped);
    const chunk = normalizeTextForCompare(rawChunk);

    let ok = 0, err = 0;
    const upto = Math.min(typed.length, chunk.length);

    for (let i=0;i<upto;i++){
      if (typed[i] === chunk[i]) ok++;
      else err++;
    }
    if (typed.length > chunk.length) err += (typed.length - chunk.length);

    state.chunkOk = ok;
    state.chunkErr = err;

    // global
    // (catatan: global ok dihitung dari penjumlahan setiap chunk saat commit,
    // tapi realtime kita tampilkan global sementara = already committed + chunk realtime)
    const committedOk = state.charOkTotal;
    const committedErr = state.err;

    const totalOk = committedOk + ok;
    const totalErr = committedErr + err;
    const totalAll = totalOk + totalErr;

    el.okCount.textContent = String(totalOk);
    el.errCount.textContent = String(totalErr);
    el.itemTotal.textContent = `Item total: ${totalAll}`;

    renderChunkPrompt(rawTyped, rawChunk);

    const acc = totalAll ? Math.round((totalOk / totalAll) * 100) : 0;
    el.liveHint.innerHTML = `Realtime: <b>${acc}%</b> akurasi • Benar <b>${totalOk}</b> • Salah <b>${totalErr}</b>.`;
  }

  function commitAndNext(){
    if (state.phase !== "test") return;

    // commit current chunk score into global
    state.charOkTotal += state.chunkOk;
    state.err += state.chunkErr;

    state.ok = state.charOkTotal;

    // reset chunk realtime counters
    state.chunkOk = 0;
    state.chunkErr = 0;

    // lanjut chunk
    state.chunkIndex = Math.min(state.chunkIndex + 1, state.chunks.length - 1);
    showChunk();

    // update report realtime
    updateReport();
  }

  // =========================
  // 11) FINISH
  // =========================
  function finishNow(auto=false){
    clearInterval(state.timerId);
    state.timerId = null;

    if (state.phase === "practice"){
      startTest();
      return;
    }

    if (state.phase === "test"){
      // commit terakhir (kalau ada yang sudah diketik)
      computeChunkRealtime();
      state.charOkTotal += state.chunkOk;
      state.err += state.chunkErr;
      state.ok = state.charOkTotal;

      // finalize minute + status
      finalizeMinute(state.minuteIndex);
      setPhase("done");
      el.timeLeft.textContent = "00:00";

      el.liveHint.innerHTML = auto
        ? "Waktu habis. Data sedang dikirim ke Google Sheet. Silakan buka <b>Report</b> atau <b>Kurva Kerja</b>."
        : "Tes dihentikan. Data sedang dikirim ke Google Sheet. Silakan buka <b>Report</b> atau <b>Kurva Kerja</b>.";

      updateReport();
      drawCurve();

      saveToSheet(buildPayload());
    }
  }

  // =========================
  // 12) TIMER + CURVE
  // =========================
  function tickLoop(onEnd){
    clearInterval(state.timerId);
    state.timerId = setInterval(() => {
      state.secondsLeft = Math.max(0, state.secondsLeft - 1);
      el.timeLeft.textContent = fmtTime(state.secondsLeft);

      if (state.phase === "test"){
        const elapsed = TEST_SECONDS - state.secondsLeft;
        const minute = Math.min(10, Math.max(1, Math.ceil(elapsed / 60)));
        el.minuteLine.textContent = `Menit ${minute} / 10`;

        const currentMinuteIndex = Math.floor(elapsed / 60); // 0..9
        if (currentMinuteIndex !== state.minuteIndex && currentMinuteIndex <= 9){
          finalizeMinute(state.minuteIndex);
          state.minuteIndex = currentMinuteIndex;
          state.minuteCharOkStart = state.charOkTotal;
        }
      }

      if (state.secondsLeft <= 0){
        clearInterval(state.timerId);
        state.timerId = null;
        if (state.phase === "test") finalizeMinute(state.minuteIndex);
        onEnd && onEnd();
      }
    }, 1000);
  }

  function finalizeMinute(idx){
    if (idx < 0 || idx > 9) return;
    const charsInMinute = state.charOkTotal - state.minuteCharOkStart;
    const wpm = Math.round(charsInMinute / WORD_UNIT);
    state.wpmByMinute[idx] = clamp(wpm, 0, 999);
    drawCurve();
  }

  // =========================
  // 13) REPORT
  // =========================
  function updateReport(){
    let minutes = 10;
    if (state.startAt && (state.phase === "done" || state.phase === "test")){
      const elapsedMs = Math.max(1, Date.now() - state.startAt);
      minutes = Math.max(1/60, elapsedMs / 60000);
    }

    const ok = state.ok || 0;
    const err = state.err || 0;
    const total = ok + err;

    const acc = total ? (ok / total) : 0;
    const wpm = minutes ? Math.round((ok / WORD_UNIT) / minutes) : 0;
    const cpm = minutes ? Math.round(ok / minutes) : 0;

    el.rWpm.textContent = String(wpm);
    el.rCpm.textContent = String(cpm);
    el.rAcc.textContent = `${Math.round(acc*100)}%`;
    el.rChars.textContent = String(total);
    el.rOk.textContent = String(ok);
    el.rErr.textContent = String(err);
  }

  function drawCurve(){
    const c = el.canvas, ctx = c.getContext("2d");
    const w = c.width, h = c.height;
    ctx.clearRect(0,0,w,h);

    const pad = {l:50,r:18,t:18,b:38};
    const gx0 = pad.l, gx1 = w - pad.r;
    const gy0 = pad.t, gy1 = h - pad.b;

    const data = state.wpmByMinute.slice(0,10);
    const maxV = Math.max(10, ...data);

    ctx.strokeStyle = "#ead9c9"; ctx.lineWidth = 1;
    for (let i=0;i<=5;i++){
      const y = gy1 - (i/5)*(gy1-gy0);
      ctx.beginPath(); ctx.moveTo(gx0,y); ctx.lineTo(gx1,y); ctx.stroke();
    }

    ctx.strokeStyle = "#d8c3af"; ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(gx0,gy0); ctx.lineTo(gx0,gy1); ctx.lineTo(gx1,gy1); ctx.stroke();

    ctx.fillStyle = "#3a3a3a"; ctx.font = "1000 12px ui-sans-serif, system-ui";
    ctx.fillText("WPM", 10, 18);

    ctx.font = "900 11px ui-sans-serif, system-ui";
    for (let i=0;i<=5;i++){
      const v = Math.round((i/5)*maxV);
      const y = gy1 - (i/5)*(gy1-gy0);
      ctx.fillText(String(v), 12, y+4);
    }
    for (let i=0;i<10;i++){
      const x = gx0 + (i/9)*(gx1-gx0);
      ctx.fillText(String(i+1), x-3, h-14);
    }

    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 2.5;
    ctx.beginPath();
    for (let i=0;i<10;i++){
      const x = gx0 + (i/9)*(gx1-gx0);
      const y = gy1 - (data[i]/maxV)*(gy1-gy0);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    ctx.fillStyle = "#1a1a1a";
    for (let i=0;i<10;i++){
      const x = gx0 + (i/9)*(gx1-gx0);
      const y = gy1 - (data[i]/maxV)*(gy1-gy0);
      ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    }
  }

  // =========================
  // 14) PAYLOAD
  // =========================
  function buildPayload(){
    let minutes = 10;
    if (state.startAt){
      const elapsedMs = Math.max(1, Date.now() - state.startAt);
      minutes = Math.max(1/60, elapsedMs / 60000);
    }

    const ok = state.ok || 0;
    const err = state.err || 0;
    const total = ok + err;

    const acc = total ? (ok / total) : 0;
    const wpm = minutes ? Math.round((ok / WORD_UNIT) / minutes) : 0;

    return {
      kandidatNama: candidate.name,
      kandidatNoHP: candidate.phone,
      modeDipilih: candidate.mode,
      durationMinutes: +minutes.toFixed(3),
      total,
      benar: ok,
      salah: err,
      akurasi: +(acc*100).toFixed(2),
      wpm,
      wpmByMinute: state.wpmByMinute.slice()
    };
  }

  // =========================
  // 15) EVENTS
  // =========================
  pickBtns.forEach(b => b.addEventListener("click", () => setPick(b.dataset.mode)));

  btnModalStart.addEventListener("click", () => {
    errName.textContent = ""; errPhone.textContent = "";
    const name = (inpName.value || "").trim();
    const phone = normalizePhone(inpPhone.value);

    let ok = true;
    if (!name){ errName.textContent = "Nama kandidat wajib diisi."; ok = false; }
    if (!phone){ errPhone.textContent = "No HP wajib diisi."; ok = false; }
    else if (!isValidPhone(phone)){ errPhone.textContent = "Format no HP tidak valid. Gunakan 08xxxxxxxxxx."; ok = false; }
    if (!ok) return;

    candidate.name = name;
    candidate.phone = phone;

    try{ localStorage.setItem("bei_candidate", JSON.stringify({name, phone})); }catch(e){}

    closeCandidateModal();
    syncIdentityUI();

    // enable start
    el.btnStart.disabled = false;

    // auto start based on chosen mode
    if (candidate.mode === "practice") startPractice();
    else startTest();
  });

  el.btnNew.addEventListener("click", () => openCandidateModal());

  el.btnStart.addEventListener("click", () => {
    if (!candidate.phone) return openCandidateModal();
    if (state.phase === "idle" || state.phase === "done"){
      (candidate.mode === "practice") ? startPractice() : startTest();
    }
  });

  el.btnFinish.addEventListener("click", () => {
    if (state.phase === "practice" || state.phase === "test") finishNow(false);
  });

  // input realtime
  el.inputBox.addEventListener("input", () => {
    if (state.phase === "practice"){
      // practice: compare vs practicePrompt (opsional), kita tampilkan sederhana
      // biar kandidat tidak pusing, practice hanya timer dan feel
      const typed = normalizeTextForCompare(el.inputBox.value || "");
      const prompt = normalizeTextForCompare(state.practicePrompt || "");
      let ok=0, err=0;
      const upto = Math.min(typed.length, prompt.length);
      for (let i=0;i<upto;i++){
        if (typed[i] === prompt[i]) ok++; else err++;
      }
      if (typed.length > prompt.length) err += (typed.length - prompt.length);

      el.okCount.textContent = String(ok);
      el.errCount.textContent = String(err);
      el.itemTotal.textContent = `Item total: ${ok + err}`;

      // highlight practice
      // (pakai renderChunkPrompt supaya konsisten)
      renderChunkPrompt(el.inputBox.value || "", state.practicePrompt || "");

      return;
    }

    if (state.phase !== "test") return;
    computeChunkRealtime();
    updateReport();
  });

  // Enter untuk next chunk (tes utama)
  el.inputBox.addEventListener("keydown", (e) => {
    if (state.phase !== "test") return;
    if (e.key === "Enter"){
      e.preventDefault();
      commitAndNext();
    }
  });

  el.btnReport.addEventListener("click", () => { updateReport(); switchTab("reportView"); });
  el.btnCurve.addEventListener("click", () => { drawCurve(); switchTab("curveView"); });

  el.tabs.forEach(t => t.addEventListener("click", () => {
    const id = t.dataset.tab;
    if ((id === "reportView" || id === "curveView") && state.phase !== "done") return;
    if (id === "reportView") updateReport();
    if (id === "curveView") drawCurve();
    switchTab(id);
  }));

  el.btnSave.addEventListener("click", () => {
    if (state.phase !== "done") return;
    saveToSheet(buildPayload());
    alert("Data dikirim ulang ke Google Sheet.");
  });

  // Mobile toggle detail
  function setToggleLabel(){
    const expanded = el.sidebar.classList.contains("sidebar-expanded");
    el.btnToggleStats.textContent = expanded ? "Sembunyikan Detail" : "Tampilkan Detail";
  }
  el.btnToggleStats.addEventListener("click", () => {
    el.sidebar.classList.toggle("sidebar-expanded");
    setToggleLabel();
  });
  setToggleLabel();

  // =========================
  // 16) INIT
  // =========================
  resetAll();
  openCandidateModal();
})();
</script>
</body>
</html>

